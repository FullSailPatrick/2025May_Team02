name: Discord Commit Feed

on:
  push:
    branches: ["**"]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      # 1 — check out code
      - uses: actions/checkout@v4

      # 2 — build the message
      - name: Build payload
        id: build
        run: |
          echo "REPO=${{ github.repository }}"                      >> $GITHUB_ENV
          echo "BRANCH=${GITHUB_REF#refs/heads/}"                   >> $GITHUB_ENV
          echo "AUTHOR=${{ github.event.pusher.name }}"             >> $GITHUB_ENV
          echo "TIME=$(TZ=America/New_York date '+%A %m-%d-%Y %I:%M %p EST')" >> $GITHUB_ENV
          echo "COMMIT=$(git log -1 --pretty=format:'%h %s')"       >> $GITHUB_ENV

          # ----- build multiline message -----
          cat <<EOF > msg.txt
          :white_check_mark: GitHub push detected
          Repo:   $REPO
          Branch: $BRANCH
          Author: $AUTHOR
          Time:   $TIME
          Commit: $COMMIT
          Link:
          https://github.com/$REPO/commit/${{ github.sha }}
          EOF
          # -----------------------------------

      # 3 — post to Discord
      - name: Post to Discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          curl -s -H "Content-Type: application/json" \
               -d "{\"content\": \"\`\`\`\n$(cat msg.txt)\n\`\`\`\"}" \
               "$WEBHOOK"
